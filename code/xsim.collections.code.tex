\XSIMmodule{collections}{collect exercises and print collected exercises}

\seq_new:N \g__xsim_collections_seq
\bool_new:N \l____xsim_active_bool

\msg_new:nnn {xsim} {collection-exists}
  {
    The~ collection~ `#1'~ you're~ trying~ to~ define~ \msg_line_context:
    \c_space_tl already~ exists.
  }

\msg_new:nnn {xsim} {collection-unknown}
  {
    The~ collection~ `#1'~ does~ not~ seem~ to~ exist~ \msg_line_context: .
    If~ this~ is~ notÂ¨ a~ typo~ define~ it~ first.
  }

\msg_new:nnn {xsim} {collection-activate}
  {
    The~ collection~ `#1'~ is~ already~ active~ \msg_line_context: .~
    Not~ activating~ it~ now.
  }

\msg_new:nnn {xsim} {collection-deactivate}
  {
    The~ collection~ `#1'~ is~ not~ active~ \msg_line_context: .~
    Not~ deactivating~ it~ now.
  }

% ----------------------------------------------------------------------------
\xsim_declare_property:nnnn
  { \c_false_bool }
  { \c_false_bool }
  { \c_false_bool }
  {collections}

% #1: collection name
% #2: conditions: clist of <tag>=<value>
\cs_new_protected:Npn \xsim_new_collection:nn #1#2
  {
    \xsim_if_collection_exist:nTF {#1}
      { \msg_error:nnn {xsim} {collection-exists} {#1} }
      {
        \xsim_verbose:n { Declaring~ new~ collection~ `#1'. }
        \xsim_attribute_new:nn {collection} {#1}
        \xsim_attribute_set:nnn {collection} {#1} { \c_false_bool }
        \xsim_attribute_new:nn {collection:conditions} {#1}
        \xsim_attribute_set:nnn {collection:conditions} {#1} {#2}
        \seq_gput_right:Nn \g__xsim_collections_seq {#1}
        \xsim_new_list:n {collection:#1}
        \seq_new:c {g__xsim_collection_#1_seq}
      }
  }

% #1: collection name
\prg_new_conditional:Npnn \xsim_if_collection_exist:n #1 {T,F,TF}
  {
    \seq_if_in:NnTF \g__xsim_collections_seq {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }

\cs_new_protected:Npn \xsim_foreach_collection:n #1
  { \seq_map_inline:Nn \g__xsim_collections_seq {#1} }

\cs_new:Npn \xsim_collection_map_break: { \seq_map_break: }

% ----------------------------------------------------------------------------
% #1: collection name
\prg_new_conditional:Npnn \xsim_if_collection_active:n #1 {T,F,TF}
  {
    \xsim_attribute_if_set:nnTF {collection} {#1}
      {
        \bool_if:nTF
          { \xsim_attribute_get:nn {collection} {#1} }
          { \prg_return_true: }
          { \prg_return_false: }
      }
      { \prg_return_false: }
  }

% #1: collection name
\cs_new_protected:Npn \xsim_activate_collection:n #1
  {
    \xsim_if_collection_exist:nTF {#1}
      {
        \xsim_if_collection_active:nTF {#1}
          { \msg_warning:nnn {xsim} {collection-activate} {#1} }
          {
            \xsim_verbose:n { Activating~ collection~ `#1'. }
            \xsim_attribute_set:nnn {collection} {#1} { \c_true_bool }
          }
      }
      { \msg_error:nnn {xsim} {collection-unknown} {#1} }
  }

% #1: collection name
\cs_new_protected:Npn \xsim_deactivate_collection:n #1
  {
    \xsim_if_collection_exist:nTF {#1}
      {
        \xsim_if_collection_active:nTF {#1}
          {
            \xsim_verbose:n { Deactivating~ collection~ `#1'. }
            \xsim_attribute_set:nnn {collection} {#1} { \c_false_bool }
          }
          { \msg_warning:nnn {xsim} {collection-deactivate} {#1} }
      }
      { \msg_error:nnn {xsim} {collection-unknown} {#1} }
  }

% ----------------------------------------------------------------------------
\bool_new:N \l____xsim_collection_condition_bool
% #1: collection name
% #2: type
% #3: ID
\prg_new_protected_conditional:Npnn \xsim_collection_conditions_if:nnn #1#2#3 {T,F,TF}
  {
    \bool_set_false:N \l____xsim_collection_condition_bool
    \clist_set:Nx \l__xsim_tmpa_clist
      { \xsim_attribute_get:nn {collection:conditions} {#1} }
    \clist_if_empty:NTF \l__xsim_tmpa_clist
      { \bool_set_true:N \l____xsim_collection_condition_bool }
      {
        \clist_map_inline:Vn
          \l__xsim_tmpa_clist
          {
            \tl_set:Nx \l__xsim_tmpa_tl
              { \__xsim_get_condition_tag:w ##1 \q_stop }
            \tl_set:Nx \l__xsim_tmpb_tl
              { \__xsim_get_condition_values:w ##1 \q_stop }
            \xsim_has_tags:nnVVT {#2} {#3} \l__xsim_tmpa_tl \l__xsim_tmpb_tl
              {
                \bool_set_true:N \l____xsim_collection_condition_bool
                \clist_map_break:
              }
          }
      }
    \bool_if:NTF \l____xsim_collection_condition_bool
      { \prg_return_true: }
      { \prg_return_false: }
  }

\cs_new:Npn \__xsim_get_condition_tag:w #1=#2 \q_stop {#1}
\cs_new:Npn \__xsim_get_condition_values:w #1=#2 \q_stop {#2}

% #1: type
% #2: ID
\cs_new_protected:Npn \xsim_collect:nn #1#2
  {
    \xsim_foreach_collection:n
      {
        \xsim_if_collection_active:nT {##1}
          {
            \xsim_collection_conditions_if:nnnT {##1} {#1} {#2}
              { \xsim_add_to_collection:nnn {##1} {#1} {#2} }
          }
      }
  }
\cs_generate_variant:Nn \xsim_collect:nn {nV}

% #1: collection name
% #2: type
% #3: ID
\cs_new_protected:Npn \xsim_add_to_collection:nnn #1#2#3
  {
    \xsim_verbose:n
      { Adding~ exercise~ type~ `#2'~ ID~ `#3'~ to~ collection~ `#1'. }
    \clist_set:Nx \l__xsim_tmpa_clist
      { \xsim_get_property:nnn {#2} {#3} {collections} }
    \clist_if_in:NnF \l__xsim_tmpa_clist {#1}
      { \clist_put_right:Nn \l__xsim_tmpa_clist {#1} }
    \xsim_set_property:nnnV {#2} {#3} {collections} \l__xsim_tmpa_clist
    \seq_if_in:cnF {g__xsim_collection_#1_seq} {#2:#3}
      { \seq_put_right:cn {g__xsim_collection_#1_seq} {#2:#3} }
  }

% ----------------------------------------------------------------------------
\bool_new:N \l__xsim_printcollection_headings_bool
\tl_new:N   \l__xsim_printcollection_headings_template_tl
\tl_new:N   \l__xsim_print_collection_choice_tl

\keys_define:nn {xsim/print-collection}
  {
    headings          .bool_set:N = \l__xsim_printcollection_headings_bool ,
    headings          .initial:n  = false ,
    headings-template .tl_set:N   = \l__xsim_printcollection_headings_template_tl ,
    headings-template .initial:n  = collection ,
    print             .tl_set:N   = \l__xsim_print_collection_choice_tl ,
    print             .initial:n  = exercises
  }

% #1: options
% #2: collection name
\cs_new_protected:Npn \xsim_print_collection:nn #1#2
  {
    \group_begin:
      \keys_set:nn {xsim/print-collection} {#1}
      \xsim_foreach_exercise_type_id:nn {}
        {
          \xsim_get_property_if_set:nnnT {##1} {##2} {collections}
            {
              \clist_if_in:NnT \l_xsim_property_value_tl {#2}
                {
                  \str_case:VnF \l__xsim_print_collection_choice_tl
                    {
                      {exercises} { \xsim_insert:nnnn {##1} {##2} {} {exercise} }
                      {solutions} { \xsim_insert:nnnn {##1} {##2} {} {solution} }
                      {both} {
                        \xsim_insert:nnnn {##1} {##2} {} {exercise}
                        \xsim_insert:nnnn {##1} {##2} {} {soltion}
                      }
                    }
                    {
                      \msg_warning:nnV {xsim} {print-collection-choice}
                        \l__xsim_print_collection_choice_tl
                      \xsim_insert:nnnn {##1} {##2} {} {exercise}
                    }
                }
            }
        }
    \group_end:
  }

% ----------------------------------------------------------------------------
\xsim_new_collection:nn {all~ exercises} {}
\xsim_activate_collection:n {all~ exercises}

\XSIMmoduleend
