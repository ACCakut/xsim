% ----------------------------------------------------------------------------
% the XSIM package - exercises module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{exercises}{main exercises definitions}

\xsim_load_modules:n {base,properties,templates}
% \RequirePackage {environ}

\seq_new:N \l__xsim_parameters_seq

\cs_new_protected:Npn \xsim_declare_parameter:n #1
  {
    \xsim_if_parameter_exist:nF {#1}
      { \seq_put_right:Nn \l__xsim_parameters_seq {#1} }
  }

\cs_new_protected:Npn \xsim_remove_parameter:n #1
  {
    \xsim_if_parameter_exist:nT {#1}
      { \seq_remove_all:Nn \l__xsim_parameters_seq {#1} }
  }

\prg_new_conditional:Npnn \xsim_if_parameter_exist:n #1 {p,T,F,TF}
  {
    \seq_if_in:NnTF \l__xsim_parameters_seq {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }

\cs_generate_variant:Nn \xsim_if_parameter_exist:nT {x}

% #1: type
% #2: csv list of parameters
\cs_new_protected:Npn \xsim_set_parameters:nn #1#2
  {
    \clist_map_inline:nn {#2}
      {
        \seq_set_split:Nnx \l__xsim_tmpa_seq {=} { \tl_trim_spaces:n {##1} }
        \xsim_if_parameter_exist:xT { \seq_item:Nn \l__xsim_tmpa_seq {1} }
          {
            \prop_put:cxx {l__xsim_#1_parameters_prop}
              { \seq_item:Nn \l__xsim_tmpa_seq {1} }
              { \seq_item:Nn \l__xsim_tmpa_seq {2} }
          }
        % TODO: check if *all* parameters have been set; issue error for each
        % missing paramater
      }
    \xsim_if_debug:T { \prop_show:c {l__xsim_#1_parameters_prop} }
  }
\cs_generate_variant:Nn \xsim_set_parameters:nn {nx}

% #1: type
% #2: parameter
% #3: value
\cs_new_protected:Npn \xsim_set_parameter:nnn #1#2#3
  {
    \xsim_if_parameter_exist:nT {#2}
      { \prop_put:cnn {l__xsim_#1_parameters_prop} {#2} {#3} }
  }

% #1: type
% #2: parameter
\cs_new:Npn \xsim_get_parameter:nn #1#2
  { \prop_item:cn {l__xsim_#1_parameters_prop} {#2} }

\prg_new_conditional:Npnn \xsim_if_parameter:nn #1#2 {p,T,F,TF}
  {
    \prop_if_in:cnTF {l__xsim_#1_parameters_prop} {#2}
      { \prg_return_true: }
      { \prg_return_false: }
  }

\xsim_declare_parameter:n {exercise-env}
\xsim_declare_parameter:n {solution-env}
\xsim_declare_parameter:n {exercise-name}
\xsim_declare_parameter:n {solution-name}
\xsim_declare_parameter:n {exercise-template}
\xsim_declare_parameter:n {solution-template}
\xsim_declare_parameter:n {counter}

\cs_new_protected:Npn \xsim_define_exercise_type_variables:n #1
  {
    % \prop_new:c {l__xsim_#1_properties_prop}
    \prop_new:c {l__xsim_#1_parameters_prop}
  }

\int_new:N \g_xsim_id_int
\tl_new:N \l_xsim_current_id_tl

\cs_new_protected:Npn \xsim_define_counter:n #1
  {
    \cs_if_exist:cF { c@ \xsim_get_parameter:nn {#1} {counter} }
      { \newcounter { \xsim_get_parameter:nn {#1} {counter} } }
  }

\cs_new_protected:Npn \xsim_declare_exercise_type:nn #1#2
  {
    \xsim_define_exercise_type_variables:n {#1}
    \xsim_set_parameters:nn {#1} {#2}
    \xsim_if_parameter:nnF {#1} {counter}
      {
        \xsim_set_parameters:nx {#1}
          { counter =  \xsim_get_parameter:nn {#1} {exercise-env} }
      }
    \xsim_define_counter:n {#1}
    \NewDocumentEnvironment
      { \xsim_get_parameter:nn {#1} {exercise-env} } {O{}}
      {
        \xsim_start_exercise:nn {#1} {##1}
        \xsim_start_environment:nVn {#1} \ExerciseID {exercise}
      }
      {
        \xsim_stop_environment:nVn {#1} \ExerciseID {exercise}
        \xsim_if_debug:T { \prop_show:N \g__xsim_properties_prop }
      }
    % TODO: have separate properties for solutions!
    \NewDocumentEnvironment
      { \xsim_get_parameter:nn {#1} {solution-env} } {}
      {
        \xsim_set_properties:nnx {#1} { \int_use:N \g_xsim_id_int }
          { name = \xsim_get_parameter:nn {#1} {solution-name} }
        \xsim_start_environment:nVn {#1} \ExerciseID {solution}
      }
      { \xsim_stop_environment:nVn {#1} \ExerciseID {solution} }
  }

\cs_new_protected:Npn \xsim_start_exercise:nn #1#2
  {
    \int_gincr:N \g_xsim_id_int
    \refstepcounter { \xsim_get_parameter:nn {#1} {counter} }
    \xsim_set_properties:nnx {#1} { \int_use:N \g_xsim_id_int }
      {
        name = \xsim_get_parameter:nn {#1} {exercise-name} ,
        counter = \use:c { the \xsim_get_parameter:nn {#1} {counter} } ,
        print = true ,
        \exp_not:n {#2} ,
        id = \int_use:N \g_xsim_id_int
      }
    \tl_gset:Nn \ExerciseID {}
    \xsim_gsave_property:nxnN {#1} { \int_use:N \g_xsim_id_int } {id}
      \ExerciseID
    \tl_gset:Nn \ExerciseType {#1}
    \xsim_if_debug:T { \tl_show:N \ExerciseID }
  }

\RequirePackage{filecontents}

\cs_new_eq:NN \__xsim_file_contents:n \filec@ntents
\cs_new_eq:NN \xsim_end_file_contents: \endfilecontents

\group_begin:
  \char_set_catcode_active:n {13}%
  \tl_const:Nn \c__xsim_active_eol_tl {^^M}%
\group_end:

\show \token_new:Nn
\cs_generate_variant:Nn \use:nn {nx}

\cs_new_protected:Npn \xsim_file_contents:n #1
  { \use:nx { \__xsim_file_contents:n {#1} } { \c__xsim_active_eol_tl } }

\cs_new_protected:Npn \xsim_save_environment_body:nnn #1#2#3
  {
    \group_begin:
      \@tempswafalse
      \xsim_file_contents:n {xsim-#1-#2-#3-body.tex}
  }

\cs_new_protected:Npn \xsim_save_environment_body_end:nnn #1#2#3
  {
      \xsim_end_file_contents:
    \group_end:
  }
  
% #1: type
% #2: id
% #3: exercise|solution
\cs_new_protected:Npn \xsim_start_environment:nnn #1#2#3
  { \xsim_save_environment_body:nnn {#1} {#2} {#3} }
\cs_generate_variant:Nn \xsim_start_environment:nnn {nV}

% #1: type
% #2: id
% #3: exercise|solution
\cs_new_protected:Npn \xsim_stop_environment:nnn #1#2#3
  {
    \xsim_save_environment_body_end:nnn {#1} {#2} {#3}
    \xsim_if_print:nnnT {#1} {#2} {#3}
      {
        \par
        \xsim_use_template:nx
          {begin}
          { \xsim_get_parameter:nn {#1} {#3-template} }
        \file_input:n {xsim-#1-#2-#3-body.tex}
        \xsim_use_template:nx
          {end}
          { \xsim_get_parameter:nn {#1} {#3-template} }
        \par
      }
  }
\cs_generate_variant:Nn \xsim_stop_environment:nnn {nV}

\prg_new_protected_conditional:Npnn \xsim_exercise_if_print:nn #1#2 {T,F,TF}
  {
    \bool_if:cTF {c_ \xsim_get_property:nnn {#1} {#2} {print} _bool}
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \xsim_exercise_if_print:nnT {nV}

\prg_new_protected_conditional:Npnn \xsim_solution_if_print:nn #1#2 {T,F,TF}
  {
    \bool_if:nTF { \c_false_bool }
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \xsim_solution_if_print:nnT {nV}

\cs_new_protected:Npn \xsim_if_print:nnnT #1#2#3#4
  { \use:c {xsim_#3_if_print:nnT} {#1} {#2} {#4} }

\NewDocumentCommand \DeclareExerciseType {mm}
  { \xsim_declare_exercise_type:nn {#1} {#2} }

% ----------------------------------------------------------------------------
