% ----------------------------------------------------------------------------
% the XSIM package - exercises module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{exercises}{main exercises definitions}

\xsim_load_modules:n {base,properties,environments,templates,solutions,tags,goals}

\seq_new:N  \l__xsim_parameters_seq
\int_new:N  \g_xsim_id_int
\int_new:N  \g_xsim_max_id_int
\tl_new:N   \l_xsim_current_id_tl
\tl_new:N   \g_xsim_exercise_id_tl
\tl_new:N   \ExerciseID
\bool_new:N \l____xsim_print_bool

% ----------------------------------------------------------------------------

\xsim_new_list:n {types}
\xsim_new_list:n {print}
  
\cs_new_protected:Npn \xsim_declare_parameter:n #1
  {
    \xsim_verbose:n { Declaring~ parameter~ `#1'. }
    \xsim_if_parameter_exist:nF {#1}
      { \seq_put_right:Nn \l__xsim_parameters_seq {#1} }
  }

\cs_new_protected:Npn \xsim_remove_parameter:n #1
  {
    \xsim_verbose:n { Removing~ parameter~ `#1'. }
    \xsim_if_parameter_exist:nT {#1}
      { \seq_remove_all:Nn \l__xsim_parameters_seq {#1} }
  }

\prg_new_conditional:Npnn \xsim_if_parameter_exist:n #1 {p,T,F,TF}
  {
    \seq_if_in:NnTF \l__xsim_parameters_seq {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }

\cs_generate_variant:Nn \xsim_if_parameter_exist:nT {x}

% #1: type
% #2: csv list of parameters
\cs_new_protected:Npn \xsim_set_parameters:nn #1#2
  {
    \clist_map_inline:nn {#2}
      {
        \seq_set_split:Nnx \l__xsim_tmpa_seq {=} { \tl_trim_spaces:n {##1} }
        \xsim_set_parameter:nxx {#1}
          { \seq_item:Nn \l__xsim_tmpa_seq {1} }
          { \seq_item:Nn \l__xsim_tmpa_seq {2} }
        % TODO: check if *all* parameters have been set; issue error for each
        % missing paramater
      }
  }
\cs_generate_variant:Nn \xsim_set_parameters:nn {nx}

% #1: type
\prg_new_conditional:Npnn \xsim_if_type:n #1 {p,T,F,TF}
  {
    \prop_if_exist:cTF {l__xsim_#1_type_parameters_prop}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1: type
% #2: parameter
% #3: value
\cs_new_protected:Npn \xsim_set_parameter:nnn #1#2#3
  {
    \xsim_if_parameter_exist:nT {#2}
      {
        \xsim_verbose:n
          { Setting~ parameter~ `#2'~ for~ type~ `#1'~ to~ `#3'. }
        \prop_put:cnn {l__xsim_#1_type_parameters_prop} {#2} {#3}
      }
  }
\cs_generate_variant:Nn \xsim_set_parameter:nnn {nnx,nxx}

% #1: type
% #2: parameter
\cs_new:Npn \xsim_get_parameter:nn #1#2
  { \prop_item:cn {l__xsim_#1_type_parameters_prop} {#2} }
\cs_generate_variant:Nn \xsim_get_parameter:nn {o}

\prg_new_conditional:Npnn \xsim_if_parameter:nn #1#2 {p,T,F,TF}
  {
    \prop_if_in:cnTF {l__xsim_#1_type_parameters_prop} {#2}
      { \prg_return_true: }
      { \prg_return_false: }
  }

\xsim_declare_parameter:n {exercise-env}
\xsim_declare_parameter:n {solution-env}
\xsim_declare_parameter:n {exercise-name}
\xsim_declare_parameter:n {solution-name}
\xsim_declare_parameter:n {exercise-template}
\xsim_declare_parameter:n {solution-template}
\xsim_declare_parameter:n {counter}
\xsim_declare_parameter:n {number}

% ----------------------------------------------------------------------------
% inside the argument `#1' refers to the type
\cs_new_protected:Npn \xsim_foreach_exercise_type:n #1
  { \seq_map_inline:Nn \g__xsim_list_types_seq {#1} }

\cs_new_protected:Npn \xsim_foreach_exercise_id:n #1
  { \int_step_inline:nnnn {1} {1} { \g_xsim_max_id_int } {#1} }

\cs_new:Npn \__xsim_deliver_exercise_details:nn #1#2
  {
    \xsim_if_in_list:nnT {print} {#1-#2}
      {
        \__xsim_loop_item:nnxxxx
          {#1}
          {#2}
          { \xsim_get_property:nnn {#1} {#2} {counter} }
          { \xsim_get_property:nnn {#1} {#2} {subtitle} }
          { \xsim_get_property:nnn {#1} {#2} {points} }
          { \xsim_get_property:nnn {#1} {#2} {bonus-points} }
       }
  }

\xsim_define_loop_macro:Nnn \xsim_foreach_exercise_type_id:n
  {nnnnnn}
  {
    \cs_generate_variant:Nn \__xsim_loop_item:nnnnnn {nnxxxx}
    \xsim_foreach_exercise_type:n
      {
        \xsim_foreach_exercise_id:n
          { \__xsim_deliver_exercise_details:nn {##1} {####1} }
      }
  }

\xsim_define_loop_macro:Nnn \xsim_foreach_exercise_id_type:n
  {nnnnnn}
  {
    \xsim_foreach_exercise_id:n
      {
        \xsim_foreach_exercise_type:n
          { \__xsim_deliver_exercise_details:nn {##1} {####1} }
      }
  }

\cs_new_protected:Npn \xsim_define_exercise_type_variables:n #1
  { \prop_new:c {l__xsim_#1_type_parameters_prop} }

\cs_new_protected:Npn \xsim_define_counter:n #1
  {
    \cs_if_exist:cF { c@ \xsim_get_parameter:nn {#1} {counter} }
      { \newcounter { \xsim_get_parameter:nn {#1} {counter} } }
    \cs_if_exist:cF { c@ number of \xsim_get_parameter:nn {#1} {exercise-env} s }
      { \newcounter { number of \xsim_get_parameter:nn {#1} {exercise-env} s } }
  }

% #1: type
\cs_new_protected:Npn \xsim_declare_exercise_type:nn #1#2
  {
    \xsim_if_type:nTF {#1}
      { % error message
      }
      {
        \xsim_verbose:n { Declaring~ new~ exercise~ type~ `#1'. }
        \xsim_define_exercise_type_variables:n {#1}
        \xsim_add_to_list:nn {types} {#1}
        \xsim_set_parameters:nn {#1} {#2}
        \xsim_set_parameter:nnx {#1} {number}
          { number of \xsim_get_parameter:nn {#1} {exercise-env} s }
        \xsim_if_parameter:nnF {#1} {counter}
          {
            \xsim_set_parameters:nx {#1}
              { counter =  \xsim_get_parameter:nn {#1} {exercise-env} }
          }
        \xsim_define_counter:n {#1}
        \bool_new:c {l__xsim_#1_solution_print_bool}
        \bool_new:c {l__xsim_#1_exercise_print_bool}
        \keys_define:nx {xsim}
          {
            \xsim_get_parameter:nn {#1} {solution-env} / print
              .bool_set:N = \exp_not:c {l__xsim_#1_solution_print_bool} ,
            \xsim_get_parameter:nn {#1} {solution-env} / print
              .initial:n  = false ,
            \xsim_get_parameter:nn {#1} {exercise-env} / print
              .bool_set:N = \exp_not:c {l__xsim_#1_exercise_print_bool} ,
            \xsim_get_parameter:nn {#1} {exercise-env} / print
              .initial:n  = true
          }
        \xsim_new_environment:nn {#1} {exercise}
        \xsim_new_environment:nn {#1} {solution}
      }
  }

% #1: type
% #2: options
\cs_new_protected:Npn \xsim_start_exercise:nn #1#2
  {
    \int_gincr:N \g_xsim_id_int
    \int_compare:nF { \g_xsim_max_id_int > \g_xsim_id_int }
      { \int_gset_eq:NN \g_xsim_max_id_int \g_xsim_id_int }
    \xsim_set_properties:nxx {#1} { \int_use:N \g_xsim_id_int }
      {
        name = \xsim_get_parameter:nn {#1} {exercise-name} ,
        print = true ,
        \exp_not:n {#2} ,
        id = \int_use:N \g_xsim_id_int
      }
    \tl_gclear:N \g_xsim_exercise_id_tl
    \xsim_gsave_property:nxnN {#1} { \int_use:N \g_xsim_id_int } {id}
      \g_xsim_exercise_id_tl
    \tl_gset_eq:NN \ExerciseID \g_xsim_exercise_id_tl
    \tl_gset:Nn \ExerciseType {#1}
    \xsim_verbose:x
      {
        Starting~ exercise~ type~ `#1' with~ id~
        ` \g_xsim_exercise_id_tl '.
      }
    \xsim_exercise_if_print:nVTF {#1} \g_xsim_exercise_id_tl
      {
        \xsim_add_to_list:nx {print} { #1 - \g_xsim_exercise_id_tl }
        \stepcounter { \xsim_get_parameter:nn {#1} {number} }
        \refstepcounter { \xsim_get_parameter:nn {#1} {counter} }
        \xsim_set_properties:nVx {#1} \g_xsim_exercise_id_tl
          { counter = \use:c { the \xsim_get_parameter:nn {#1} {counter} } }
        \xsim_update_goals:nV {#1} \g_xsim_exercise_id_tl
      }
      { \xsim_remove_from_list:nx {print} { #1 - \g_xsim_exercise_id_tl } }
  }

\cs_new_protected:Npn \xsim_stop_exercise:n #1 {}

% ----------------------------------------------------------------------------
% TODO: (think of properties, tags, ...)
% #1: type
% #2: id
\prg_new_protected_conditional:Npnn \xsim_exercise_if_print:nn #1#2 {T,F,TF}
  {
    \bool_set_true:N \l____xsim_print_bool
    \bool_if:cF {l__xsim_#1_exercise_print_bool}
      { \bool_set_false:N \l____xsim_print_bool }
    \bool_if:cF {c_ \xsim_get_property:nnn {#1} {#2} {print} _bool}
      { \bool_set_false:N \l____xsim_print_bool }
    \xsim_if_tagged:nnF {#1} {#2}
      { \bool_set_false:N \l____xsim_print_bool }
    \bool_if:NTF \l____xsim_print_bool
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \xsim_exercise_if_print:nnT  {nV}
\cs_generate_variant:Nn \xsim_exercise_if_print:nnTF {nV}

% #1: type
% #2: id
% #3: exercise|solution
\prg_new_protected_conditional:Npnn \xsim_if_print:nnn #1#2#3 {T,F,TF}
  {
    \use:c {xsim_#3_if_print:nnTF} {#1} {#2}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% ----------------------------------------------------------------------------

\cs_new_protected:Npn \XSIMid #1
  { \int_gset:Nn \g_xsim_max_id_int {#1} }

\RequirePackage {etoolbox}

\AtEndPreamble
  {
    \xsim_foreach_exercise_type:n
      {
        \tl_new:c { number of #1 s }
        \tl_set:cn { number of #1 s } {0}
        \cs_new_protected:cpn {XSIM#1} ##1
          { \tl_gset:cn { number of #1 s } {##1} }
      }
  }

\AtBeginDocument
  {
    \xsim_write_to_aux:x
      { \token_to_str:N \providecommand \token_to_str:N \XSIMid [1] {} }
    \xsim_foreach_exercise_type:n
      {
        \xsim_write_to_aux:x
          {
            \token_to_str:N \providecommand \token_to_str:N \XSIM #1 [1] {} ^^J
            \token_to_str:N \providecommand \token_to_str:N \numberof #1 s {}
          }
      }
  }
  
\AtEndDocument
  {
    \xsim_update_list:n {print}
    \xsim_update_list:n {types}
    \xsim_write_to_aux:x { \XSIMid { \int_use:N \g_xsim_id_int } }
    \xsim_foreach_exercise_type:n
      {
        \xsim_write_to_aux:x
          {
            \token_to_str:N \XSIM #1 ~
              { \arabic { \xsim_get_parameter:nn {#1} {number} } }
          }
      }
  }

% ----------------------------------------------------------------------------

\keys_define:nn {xsim}
  { path .tl_set:N = \l__xsim_file_name_path_tl }

% ----------------------------------------------------------------------------  
\tex_endinput:D
