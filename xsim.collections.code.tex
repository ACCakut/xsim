% ----------------------------------------------------------------------------
% the XSIM package - collections module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{collections}{collect exercises and print collected exercises}

\xsim_load_modules:n {base}

\prop_new:N \g__xsim_collections_prop
\prop_new:N \g__xsim_collected_exercises_prop
\bool_new:N \l____xsim_active_bool

% ----------------------------------------------------------------------------

% #1: collection name
\cs_new_protected:Npn \xsim_activate_collection:n #1
  { \prop_gput:Nnn \g__xsim_collections_prop {#1} { \c_true_bool } }

% #1: collection name
\cs_new_protected:Npn \xsim_deactivate_collection:n #1
  { \prop_gput:Nnn \g__xsim_collections_prop {#1} { \c_false_bool } }

% start collection for an exercise type:
% #1: collection name
% #2: type
\cs_new_protected:Npn \xsim_start_collection:nn #1#2
  {
    \group_begin:
    \xsim_activate_collection:n {#1}
    \keys_set:nn {xsim} { #2/print = false }
  }

% start collection for all exercise types:
% #1: collection name
\cs_new_protected:Npn \xsim_start_collection:n #1
  {
    \group_begin:
    \xsim_activate_collection:n {#1}
    \xsim_foreach_exercise_type:n
      { \keys_set:nn {xsim} { ##1/print = false } }
  }

% stop collection:
% #1: collection name
\cs_new_protected:Npn \xsim_stop_collection:n #1
  {
    \group_end:
    \xsim_deactivate_collection:n {#1}
  }

% ----------------------------------------------------------------------------

% #1: collection name
% #2: type
% #3: id
\cs_new_protected:Npn \xsim_add_to_collection:nnn #1#2#3
  {
    \prop_gput:Nnn \g__xsim_collected_exercises_prop {#1-#2-#3} {}
    % this should maybe be done when printing the collected exercises:
    % \xsim_add_to_list:nn {print} {#2-#3}
  }

% #1: collection name
% #2: type
% #3: id
\prg_new_conditional:Npnn \xsim_if_in_collection:nnn #1#2#3 {T,F,TF}
  {
    \prop_if_in:NnTF \g__xsim_collected_exercises_prop {#1-#2-#3}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% ----------------------------------------------------------------------------

% #1: collection name
\prg_new_conditional:Npnn \xsim_if_collection_active:n #1 {T,F,TF}
  {
    \prop_if_in:NnTF \g__xsim_collections_prop {#1}
      {
        \bool_if:nTF
          { \prop_item:Nn \g__xsim_collections_prop {#1} }
          { \prg_return_true: }
          { \prg_return_false: }
      }
      { \prg_return_false: }
  }

\prg_new_protected_conditional:Npnn \xsim_if_collections_active: {T,F,TF}
  {
    \bool_set_false:N \l____xsim_active_bool
    \prop_map_inline:Nn \g__xsim_collections_prop
      {
        \bool_if:nT
          { !\str_if_eq_x_p:nn {##1} {global} && ##2 }
          {
            \bool_set_true:N \l____xsim_active_bool
            \prop_map_break:
          }
      }
    \bool_if:NTF \l____xsim_active_bool
      { \prg_return_true: }
      { \prg_return_false: }
  }

% ----------------------------------------------------------------------------

\AtBeginDocument { \xsim_activate_collection:n   {global} }
\AtEndDocument   { \xsim_deactivate_collection:n {global} }
  
% ----------------------------------------------------------------------------
\tex_endinput:D
