% ----------------------------------------------------------------------------
% the XSIM package - solutions module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{solutions}{managing solutions}

\xsim_load_modules:n {tags,properties}

\bool_new:N \l__xsim_inside_solution_bool

\prg_new_conditional:Npnn \xsim_if_inside_solution: {p,T,F,TF}
  {
    \bool_if:NTF \l__xsim_inside_solution_bool
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1: type
% #2: id
\prg_new_protected_conditional:Npnn \xsim_solution_if_print:nn #1#2 {T,F,TF}
  {
    \bool_set_true:N \l____xsim_print_bool
    \bool_if:cF {l__xsim_#1_solution_print_bool}
      { \bool_set_false:N \l____xsim_print_bool }
    \xsim_if_tagged:nnF {#1} {#2}
      { \bool_set_false:N \l____xsim_print_bool }
    \xsim_if_in_list:nnF {print} {#1-#2}
      { \bool_set_false:N \l____xsim_print_bool }
    \bool_if:NTF \l____xsim_print_bool
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \xsim_solution_if_print:nnT {nV,oo}

% #1: type
% #2: options
\cs_new_protected:Npn \xsim_start_solution:nn #1#2
  {
    \keys_set:xn { xsim/\xsim_get_parameter:nn {#1} {solution-env} } {#2}
    \bool_set_true:N \l__xsim_inside_solution_bool
  }

\cs_new_protected:Npn \xsim_stop_solution:n #1 {}

% ----------------------------------------------------------------------------

\bool_new:N \l__xsim_printsolutions_headings_bool
\tl_new:N   \l__xsim_printsolutions_headings_template_tl

\keys_define:nn {xsim/print-solutions}
  {
    headings .bool_set:N = \l__xsim_printsolutions_headings_bool ,
    headings .initial:n  = true ,
    headings-template .tl_set:N = \l__xsim_printsolutions_headings_template_tl ,
    headings-template .initial:n = section*
  }

% TODO: add options (template choice, ... )
% #1: boolean -- if true only the solutions of printed exercises will be
%     output
% #2: options
% #3: type
\cs_new_protected:Npn \xsim_print_type_solutions:nnn #1#2#3
  {
    \xsim_verbose:n
      { Printing~ solutions~ for~ exercise~ type~ `#3'. }
    \group_begin:
      \bool_set_false:N \l__xsim_tmpa_bool
      \bool_if:nTF {#1}
        {
          \xsim_foreach_exercise_type_id:nn {print}
            {
              \xsim_if_in_list:nnT {print} {#3-##2=={true}}
                { \bool_set_true:N \l__xsim_tmpa_bool }
            }
        }
        {
          \xsim_foreach_exercise_type_id:nn {use}
            {
              \xsim_if_in_list:nnT {use} {#3-##2=={true}}
                { \bool_set_true:N \l__xsim_tmpa_bool }
            }
        }
      \tl_set:Nn \ExerciseType {#3}
      \bool_if:NT \l__xsim_tmpa_bool
        {
          \bool_if:NT \l__xsim_printsolutions_headings_bool
            {
              \xsim_use_template:nV
                {heading}
                \l__xsim_printsolutions_headings_template_tl
            }
          % only loops over exercises in print list which effectively makes
          % boolean #1 always true:
          % \xsim_foreach_exercise_type_id:n
          \xsim_foreach_exercise_type_id:nn {use}
            { \xsim_insert:nnnn {#3} {##2} {#2} {solution} }
        }
    \group_end:
  }

% TODO: add options (print subheadings, sort per type,...)
% #1: boolean -- if true only the solutions of printed exercises will be
%     output
% #2: options
\cs_new_protected:Npn \xsim_print_all_solutions:nn #1#2
  {
    \xsim_foreach_exercise_type:n
      { \xsim_print_type_solutions:nnn {#1} {#2} {##1} }
  }

% ----------------------------------------------------------------------------
\tex_endinput:D
