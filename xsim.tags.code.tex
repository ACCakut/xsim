% ----------------------------------------------------------------------------
% the XSIM package - tags module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{tags}{tagging of exercises}

\xsim_load_modules:n {properties}

\seq_new:N  \l__xsim_chosen_tags_seq
\bool_new:N \l__xsim_ignore_untagged_bool
\bool_new:N \l____xsim_tagged_bool

\keys_define:nn {xsim}
  {
    ingore-untagged .bool_set:N = \l__xsim_ignore_untagged_bool ,
    % .choices:nn = {true,false}
      % { \tl_set:Nn \l__xsim_ignore_untagged_tl {#1} } ,
%     ingore-untagged .default:n  = true ,
    ignore-untagged .initial:n  = false ,
    tags            .code:n     =
      \xsim_set_seq_from_clist:Nn \l__xsim_chosen_tags_seq {#1}
  }

\cs_new_protected:Npn \xsim_set_seq_from_clist:Nn #1#2
  {
    \seq_clear:N #1
    \clist_map_inline:nn {#2}
      { \tl_if_blank:nF {##1} { \seq_put_right:Nn #1 {##1} } }
  }
\cs_generate_variant:Nn \xsim_set_seq_from_clist:Nn {Nx}

% #1: type
% #2: id
\prg_new_protected_conditional:Npnn \xsim_if_tagged:nn #1#2 {T,F,TF}
  {
    \bool_set_false:N \l____xsim_tagged_bool
    \seq_if_empty:NTF \l__xsim_chosen_tags_seq
      { \bool_set_true:N \l____xsim_tagged_bool }
      {
        \xsim_set_seq_from_clist:Nx
          \l__xsim_tmpa_seq
          { \xsim_get_property:nnn {#1} {#2} {tags} }
        \seq_if_empty:NTF \l__xsim_tmpa_seq
          {
            \bool_set_eq:NN
              \l____xsim_tagged_bool
              \l__xsim_ignore_untagged_bool
          }
          {
            \seq_map_inline:Nn \l__xsim_tmpa_seq
              {
                \seq_if_in:NnTF \l__xsim_chosen_tags_seq {##1}
                  {
                    \bool_set_true:N \l____xsim_tagged_bool
                    \seq_map_break:
                  }
              }
          }
      }
    \bool_if:NTF \l____xsim_tagged_bool
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1: type
% #2: id
% #3: code
\cs_new_protected:Npn \xsim_foreach_exercise_tag:nnn #1#2#3
  {
    \xsim_set_seq_from_clist:Nx \l__xsim_tmpa_seq
      { \xsim_get_property:nnn {#1} {#2} {tags} }
    \seq_map_inline:Nn \l__xsim_tmpa_seq {#3}
  }
\cs_generate_variant:Nn \xsim_foreach_exercise_tag:nnn {oo}

% #1: type
% #2: id
% #3: sep
\cs_new_protected:Npn \xsim_exercise_tags_use:nnn #1#2#3
  {
    \xsim_set_seq_from_clist:Nx \l__xsim_tmpa_seq
      { \xsim_get_property:nnn {#1} {#2} {tags} }
    \seq_use:Nn \l__xsim_tmpa_seq {#3}
  }
\cs_generate_variant:Nn \xsim_exercise_tags_use:nnn {oo}

% #1: type
% #2: id
% #3: sep between two
% #4: sep between more than two
% #5: sep between last two
\cs_new_protected:Npn \xsim_exercise_tags_use:nnnnn #1#2#3#4#5
  {
    \xsim_set_seq_from_clist:Nx \l__xsim_tmpa_seq
      { \xsim_get_property:nnn {#1} {#2} {tags} }
    \seq_use:Nn \l__xsim_tmpa_seq {#3}
  }
\cs_generate_variant:Nn \xsim_exercise_tags_use:nnn   {oo}
\cs_generate_variant:Nn \xsim_exercise_tags_use:nnnnn {oo}

% ----------------------------------------------------------------------------
\tex_endinput:D
