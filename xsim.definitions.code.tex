% ----------------------------------------------------------------------------
% the XSIM package - definitions module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{definitions}{definition of user commands}

\xsim_load_modules:n {base,exercises,blanks,translations,interface}

\RequirePackage{array,booktabs}

% ----------------------------------------------------------------------------

\DeclareExerciseProperty* {id}
\DeclareExerciseProperty* {ID}
\DeclareExerciseProperty  {counter}
% \DeclareExerciseProperty  {counter}
\DeclareExerciseProperty  {subtitle}
\DeclareExerciseProperty  {points}
\DeclareExerciseProperty  {bonus-points}
\DeclareExerciseProperty  {print}
\DeclareExerciseProperty  {use}

\DeclareExercisePropertyAlias {ID} {id}

% ----------------------------------------------------------------------------

\DeclareExerciseTagging {tags}
\DeclareExerciseTagging {topics}

\xsimsetup{tags/ingore-untagged=false}

% ----------------------------------------------------------------------------

\DeclareExerciseGoal {points}
\DeclareExerciseGoal {bonus-points}

\NewDocumentCommand \printpoints {m}
  {
    \TotalExerciseTypeGoal {#1} {points}
      { \, \XSIMtranslate {point} }
      { \, \XSIMtranslate {points} }
  }

\NewDocumentCommand \printtotalpoints {}
  {
    \TotalExerciseGoal {points}
      { \, \XSIMtranslate {point} }
      { \, \XSIMtranslate {points} }
  }

\NewDocumentCommand \printbonus {m}
  {
    \TotalExerciseTypeGoal {#1} {bonus-points}
      { \, \XSIMtranslate {point} }
      { \, \XSIMtranslate {points} }
  }

\NewDocumentCommand \printtotalbonus {}
  {
    \TotalExerciseGoal {bonus-points}
      { \, \XSIMtranslate {point} }
      { \, \XSIMtranslate {points} }
  }

% ----------------------------------------------------------------------------

\DeclareExerciseType {exercise} {
  exercise-env      = exercise ,
  solution-env      = solution ,
  exercise-name     = \XSIMtranslate {exercise} ,
  solution-name     = \XSIMtranslate {solution} ,
  exercise-template = subsection* ,
  solution-template = subsection*
}

% ----------------------------------------------------------------------------

\DeclareExerciseEnvironmentTemplate {subsection*}
  {
    \subsection*
      {
        \XSIMmixedcase { \GetExerciseName } \nobreakspace
        \GetExerciseProperty {counter}
        \IfInsideSolutionF
          {
            \IfExercisePropertySetT {subtitle}
              { ~ { \normalfont \itshape \GetExerciseProperty {subtitle} } }
          }
    }
    \IfExercisePropertySetT {points}
      {
        \marginpar
          {
            \IfInsideSolutionTF
              {
                \(
                  \GetExerciseProperty {points}
                  \IfExercisePropertySetT {bonus-points}
                    { {}+{} \GetExerciseProperty {bonus-points} }
                \) \,
                \ExerciseGoalName {points}
                  { \XSIMtranslate {point} }
                  { \XSIMtranslate {points} }
              }
              {
                \rule {1.3cm} {1pt} /
                \(
                  \GetExerciseProperty {points}
                  \IfExercisePropertySetT {bonus-points}
                    { {}+{} \GetExerciseProperty {bonus-points} }
                \)
              }
          }
      }
  }
  {}

% ----------------------------------------------------------------------------

\DeclareExerciseHeadingTemplate {section*}
  {
    \section*
      {
        \XSIMmixedcase { \GetExerciseParameter {solution-name} s }~
         to~ the~ \XSIMmixedcase { \ExerciseType s}
      }
  }

\DeclareExerciseHeadingTemplate {subsection*}
  {
    \subsection*
      {
        \XSIMmixedcase { \GetExerciseParameter {solution-name} s }~
         to~ the~ \XSIMmixedcase { \ExerciseType s}
      }
  }

\DeclareExerciseHeadingTemplate {section}
  {
    \section
      {
        \XSIMmixedcase { \GetExerciseParameter {solution-name} s }~
         to~ the~ \XSIMmixedcase { \ExerciseType s}
      }
  }

\DeclareExerciseHeadingTemplate {subsection}
  {
    \subsection
      {
        \XSIMmixedcase { \GetExerciseParameter {solution-name} s }~
         to~ the~ \XSIMmixedcase { \ExerciseType s}
      }
  }

% ----------------------------------------------------------------------------

\DeclareExerciseTableTemplate {horizontal}
  {
    \XSIMputright \ExerciseTableCode
      {
        \toprule
        \XSIMifblankTF {\ExerciseType}
          {}
          { \XSIMmixedcase { \GetExerciseParameter {exercise-name} } }
        &
      }
    \ForEachUsedExerciseByType
      {
        \XSIMifeqTF {#1} { \ExerciseTableType {#1} }
          {
            \XSIMifblankTF { \ExerciseType }
              {
                \XSIMputright \ExerciseTableCode
                  {
                    \XSIMmixedcase
                      { \ExerciseParameterGet {#1} {exercise-name} ~ }
                  }
              }
              {}
            \XSIMputright \ExerciseTableCode { #3 & }
          }
          {}
      }
    \XSIMputright \ExerciseTableCode
      { Total \\ \midrule \XSIMmixedcase { \XSIMtranslate {point} }s & }
    \ForEachUsedExerciseByType
      {
        \XSIMifeqTF {#1} { \ExerciseTableType {#1} }
          { \XSIMputright \ExerciseTableCode { \XSIMifblankTF {#5} {0} {#5} & } }
          {}
      }
    \XSIMputright \ExerciseTableCode
      {
        \XSIMifblankTF {\ExerciseType}
          { \TotalExerciseGoal {points} {} {} }
          { \TotalExerciseTypeGoal {\ExerciseType} {points} {} {} }
        \\ \midrule
        \XSIMmixedcase { \XSIMtranslate {reached} } &
      }
    \ForEachUsedExerciseByType
      {
        \XSIMifeqTF {#1} { \ExerciseTableType {#1} }
          { \XSIMputright \ExerciseTableCode {&} }
          {}
      }
    \XSIMputright \ExerciseTableCode { \\ \bottomrule }
    \def\numberofcolumns{
      \XSIMifblankTF {\ExerciseType}
        {\g_xsim_max_id_int}
        {\csname numberof \ExerciseType s\endcsname}
      }
    \XSIMifeqF{\numberofcolumns}{0}
      {
        \begin {tabular} {l*{\numberofcolumns}{c}c}
          \ExerciseTableCode
        \end {tabular}
      }
  }

% TODO: update vertical analoguous to the horizontal template

\DeclareExerciseTableTemplate {vertical}
  {
    \XSIMputright \ExerciseTableCode
      {
        \toprule
        \XSIMifblankTF {\ExerciseType}
          {}
          { \XSIMmixedcase { \GetExerciseParameter {exercise-name} } }
        &
        \XSIMmixedcase { \XSIMtranslate {point} } s &
        \XSIMmixedcase { \XSIMtranslate {reached} } \\
        \midrule
      }
    \ForEachUsedExerciseByType
      {
        \XSIMifeqTF {#1} { \ExerciseTableType {#1} }
          {
            \XSIMifblankTF { \ExerciseType }
              {
                \XSIMputright \ExerciseTableCode
                  {
                    \XSIMmixedcase
                      { \ExerciseParameterGet {#1} {exercise-name} ~ }
                  }
              }
              {}
            \XSIMputright \ExerciseTableCode
              { #3 & \XSIMifblankTF {#5} {0} {#5} & \\ }
          }
          {}
      }
    \XSIMputright \ExerciseTableCode
      {
        \midrule
        Total &
        \XSIMifblankTF {\ExerciseType}
          { \TotalExerciseGoal {points} {} {} }
          { \TotalExerciseTypeGoal {\ExerciseType} {points} {} {} } &
        \\ \bottomrule
      }
    \begin {tabular} {ccc}
      \ExerciseTableCode
    \end {tabular}
  }

% ----------------------------------------------------------------------------

\DeclareExerciseTranslations {exercise} {
  Fallback = exercise ,
  English  = exercise ,
  French   = exercice ,
  German   = \"Ubung
}

\DeclareExerciseTranslations {question} {
  Fallback = question ,
  English  = question ,
  French   = question ,
  German   = Aufgabe
}

\DeclareExerciseTranslations {solution} {
  Fallback = solution ,
  English  = solution ,
  French   = solution ,
  German   = L\"osung
}

\DeclareExerciseTranslations {point} {
  Fallback = point ,
  English  = point ,
  French   = point ,
  German   = Punkt
}

\DeclareExerciseTranslations {points} {
  Fallback = points ,
  English  = points ,
  French   = points ,
  German   = Punkte
}

\DeclareExerciseTranslations {reached} {
  Fallback = reached ,
  English  = reached ,
  French   = atteint ,
  German   = erreicht
}

% ----------------------------------------------------------------------------
\tex_endinput:D
