% ----------------------------------------------------------------------------
% the XSIM package - properties module
% 
%   eXercise Sheets IMproved
% 
% ----------------------------------------------------------------------------
% Clemens Niederberger
% Web:    https://github.com/cgnieder/xsim
% E-Mail: contact@mychemistry.eu
% ----------------------------------------------------------------------------
% Copyright 2017 Clemens Niederberger
% 
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
% 
% This work has the LPPL maintenance status `maintained'.
% 
% The Current Maintainer of this work is Clemens Niederberger.
% ----------------------------------------------------------------------------
% If you have any ideas, questions, suggestions or bugs to report, please
% feel free to contact me.
% ----------------------------------------------------------------------------
\XSIMmodule{properties}{properties of exercises}

\xsim_load_modules:n {base}

\msg_new:nnn {xsim} {unknown-property}
  {
    You~ tried~ to~ set~ the~ property~ `#1'~ \msg_line_context: . \\
    This~ property~ does~ not~ exist.~ Check~ for~ a~ typo~ or~ \\
    define~ the~ property~ yourself.
  }

\msg_new:nnn {xsim} {property-unique}
  {
    You~ tried~ to~ set~ the~ property~ `#1'~ \msg_line_context: . \\
    This~ property~ has~ to~ have~ a~ unique~ value~ and~ thus~ \\
    cannot~ be~ set~ to~ `#2'~ since~ this~ value~ is~ already~ talen.
  }

\seq_new:N \l__xsim_properties_seq
\seq_new:N \l__xsim_unique_properties_seq
\prop_new:N \g__xsim_properties_prop

% new property:
% #1: boolean if unique
% #2: property name
\cs_new_protected:Npn \xsim_declare_property:nn #1#2
  {
    \xsim_if_property_exist:nF {#2}
      { \seq_put_right:Nn \l__xsim_properties_seq {#2} }
    \bool_if:nT {#1}
      {
        \seq_if_in:NnF \l__xsim_unique_properties_seq {#2}
          { \seq_put_right:Nn \l__xsim_unique_properties_seq {#2} }
      } 
  }

% delete existing property:
\cs_new_protected:Npn \xsim_remove_property:n #1
  {
    \xsim_if_property_exist:nT {#1}
      {
        \seq_remove_all:Nn \l__xsim_properties_seq {#1}
        \seq_remove_all:Nn \l__xsim_unique_properties_seq {#1}
      }
  }

% check if property exists:
\prg_new_conditional:Npnn \xsim_if_property_exist:n #1 {p,T,F,TF}
  {
    \seq_if_in:NnTF \l__xsim_properties_seq {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \xsim_if_property_exist:nTF {x}

\prg_new_conditional:Npnn \xsim_if_property_unique:n #1 {p,T,F,TF}
  {
    \seq_if_in:NnTF \l__xsim_unique_properties_seq {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% #1: type
% #2: ID
% #3: property
% #4: value
\cs_new_protected:Npn \__xsim_set_property:nnnn #1#2#3#4
  {
    \xsim_if_property_exist:xTF {#3}
      {
        \xsim_if_property_set:nnnTF {#1} {#2} {#3}
          {
            \xsim_if_property_unique:nTF {#3}
              { \msg_warning:nnnn {xsim} {property-unique} {#3} {#4} }
              {
                \prop_gput:Nxn \g__xsim_properties_prop
                  {#2!#1!#3}
                  {#4}
              }
          }
          {
            \prop_gput:Nxn \g__xsim_properties_prop
              {#2!#1!#3}
              {#4}
          }
      }
      { \msg_error:nnn {xsim} {unknown-property} {#3} }  
  }
\cs_generate_variant:Nn \__xsim_set_property:nnnn {nnxx,nnnV}

% set properties:
% #1: type
% #2: ID
% #3: csv list of properties
\cs_new_protected:Npn \xsim_set_properties:nnn #1#2#3
  {
    \clist_map_inline:nn {#3}
      {
        \seq_set_split:Nnx \l__xsim_tmpa_seq {=} { \tl_trim_spaces:n {##1} }
        \__xsim_set_property:nnxx
          {#1}
          {#2}
          { \seq_item:Nn \l__xsim_tmpa_seq {1} }
          { \seq_item:Nn \l__xsim_tmpa_seq {2} }
      }
  }
\cs_generate_variant:Nn \xsim_set_properties:nnn {nnx}

% check if property is set:
% #1: type
% #2: ID
% #3: property
\prg_new_protected_conditional:Npnn \xsim_if_property_set:nnn #1#2#3 {T,F,TF}
  {
    \prop_if_in:NxTF \g__xsim_properties_prop
      { #2 ! #1 ! #3 }
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \xsim_if_property_set:nnnTF {nnx,xx}

% retrieve properties:
% #1: type
% #2: ID
% #3: property
\cs_new:Npn \xsim_get_property:nnn #1#2#3
  { \prop_item:Nn \g__xsim_properties_prop { #2 ! #1 ! #3 } }
\cs_generate_variant:Nn \xsim_get_property:nnn {nx,xx}

\cs_new_protected:Npn \xsim_save_property:nnnN #1#2#3#4
  { \prop_get:NnN \g__xsim_properties_prop { #2 ! #1 ! #3 } #4 }
\cs_generate_variant:Nn \xsim_save_property:nnnN {nx,xx}

\cs_new_protected:Npn \xsim_gsave_property:nnnN #1#2#3#4
  {
    \xsim_save_property:nnnN {#1} {#2} {#3} #4
    \tl_gset:NV #4 #4
  }
\cs_generate_variant:Nn \xsim_gsave_property:nnnN {nx,xx}

% ----------------------------------------------------------------------------
% user commands:
\NewDocumentCommand \DeclareExerciseProperty {sm}
  {
    \IfBooleanTF {#1}
      { \xsim_declare_property:nn { \c_true_bool } {#2} }
      { \xsim_declare_property:nn { \c_false_bool } {#2} }
  }

% ----------------------------------------------------------------------------
